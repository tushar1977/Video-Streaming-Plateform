<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Webcam Stream</title>
  </head>
  <body>
    <h1>WebRTC Webcam Stream</h1>
    <video id="localVideo" autoplay playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <button id="startButton">Start Streaming</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      const socket = io();
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const startButton = document.getElementById("startButton");

      let localStream;
      let peerConnection;

      startButton.onclick = startStreaming;

      function startStreaming() {
        navigator.mediaDevices
          .getUserMedia({ video: true, audio: true })
          .then((stream) => {
            localStream = stream;
            localVideo.srcObject = stream;
            createPeerConnection();
            addLocalStreamToPeerConnection();
            createAndSendOffer();
          })
          .catch((error) =>
            console.error("Error accessing media devices.", error),
          );
      }

      function createPeerConnection() {
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("ice_candidate", event.candidate);
          }
        };

        peerConnection.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };
      }

      function addLocalStreamToPeerConnection() {
        localStream.getTracks().forEach((track) => {
          peerConnection.addTrack(track, localStream);
        });
      }

      function createAndSendOffer() {
        peerConnection
          .createOffer()
          .then((offer) => peerConnection.setLocalDescription(offer))
          .then(() => {
            socket.emit("offer", peerConnection.localDescription);
          })
          .catch((error) => console.error("Error creating offer.", error));
      }

      socket.on("offer", (offer) => {
        if (!peerConnection) {
          createPeerConnection();
        }
        peerConnection
          .setRemoteDescription(new RTCSessionDescription(offer))
          .then(() => peerConnection.createAnswer())
          .then((answer) => peerConnection.setLocalDescription(answer))
          .then(() => {
            socket.emit("answer", peerConnection.localDescription);
          })
          .catch((error) => console.error("Error handling offer.", error));
      });

      socket.on("answer", (answer) => {
        peerConnection
          .setRemoteDescription(new RTCSessionDescription(answer))
          .catch((error) => console.error("Error handling answer.", error));
      });

      socket.on("ice_candidate", (candidate) => {
        peerConnection
          .addIceCandidate(new RTCIceCandidate(candidate))
          .catch((error) =>
            console.error("Error adding ICE candidate.", error),
          );
      });
    </script>
  </body>
</html>
