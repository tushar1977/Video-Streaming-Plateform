<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Streaming Platform</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        background-color: #333;
        color: white;
        padding: 10px 0;
        text-align: center;
      }
      h1 {
        margin: 0;
      }
      .video-container {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        padding: 20px;
        position: relative;
      }
      #videoElement {
        width: 100%;
        max-width: 800px;
        height: auto;
        display: block;
        margin: 0 auto;
      }
      .video-controls {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 5px;
        display: none;
      }
      .video-container:hover .video-controls {
        display: block;
      }
      #playPauseBtn {
        background-color: transparent;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
      }
      .status {
        margin-top: 10px;
        text-align: center;
        font-size: 14px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Video Streaming Platform</h1>
    </header>
    <div class="container">
      <div class="video-container">
        <video id="videoElement" width="400" controls>
          Your browser does not support HTML video.
        </video>
        <div class="video-controls">
          <button id="playPauseBtn">⏸</button>
        </div>
        <div class="status">
          <p>ICE Connection: <span id="ice-connection-state"></span></p>
          <p>ICE Gathering: <span id="ice-gathering-state"></span></p>
          <p>Signaling: <span id="signaling-state"></span></p>
        </div>
      </div>
    </div>

    <script>
      const videoElement = document.getElementById("videoElement");
      const playPauseBtn = document.getElementById("playPauseBtn");
      const iceConnectionLog = document.getElementById("ice-connection-state");
      const iceGatheringLog = document.getElementById("ice-gathering-state");
      const signalingLog = document.getElementById("signaling-state");

      let pc = null;

      async function createPeerConnection() {
        console.log("Creating Peer Connection...");
        const config = {
          sdpSemantics: "unified-plan",
          iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }],
        };

        pc = new RTCPeerConnection(config);

        pc.addEventListener(
          "icegatheringstatechange",
          () => {
            console.log(`ICE Gathering State: ${pc.iceGatheringState}`);
            iceGatheringLog.textContent = pc.iceGatheringState;
          },
          false,
        );

        pc.addEventListener(
          "iceconnectionstatechange",
          () => {
            console.log(`ICE Connection State: ${pc.iceConnectionState}`);
            iceConnectionLog.textContent = pc.iceConnectionState;
          },
          false,
        );

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            console.log("New ICE candidate:", event.candidate);
          }
        };

        pc.addEventListener(
          "signalingstatechange",
          () => {
            console.log(`Signaling State: ${pc.signalingState}`);
            signalingLog.textContent = pc.signalingState;
          },
          false,
        );

        pc.onconnectionstatechange = (event) => {
          console.log("Connection state change:", pc.connectionState);
          switch (pc.connectionState) {
            case "disconnected":
              console.log("Disconnected");
              break;
            case "failed":
              console.log("Connection failed");
              break;
            case "connected":
              console.log("Connected successfully");
              break;
          }
        };

        pc.addTransceiver("video");

        pc.ontrack = function (event) {
          console.log("Track received:", event.track.kind);
          if (event.track.kind === "video") {
            videoElement.srcObject = event.streams[0];
            console.log("Video track added to video element");
          }
        };

        return pc;
      }

      async function negotiate() {
        try {
          console.log("Creating offer...");
          const offer = await pc.createOffer();
          console.log("Setting local description with offer...");
          await pc.setLocalDescription(offer);

          await new Promise((resolve) => {
            if (pc.iceGatheringState === "complete") {
              resolve();
            } else {
              pc.addEventListener(
                "icegatheringstatechange",
                function checkState() {
                  if (pc.iceGatheringState === "complete") {
                    pc.removeEventListener(
                      "icegatheringstatechange",
                      checkState,
                    );
                    resolve();
                  }
                },
              );
            }
          });

          console.log("Sending offer to the server...");
          const response = await fetch("/offer", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              sdp: pc.localDescription.sdp,
              type: pc.localDescription.type,
            }),
          });

          const answer = await response.json();
          console.log("Received answer from the server...");
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
          console.log("Remote description set with answer...");
        } catch (e) {
          console.error("Error during negotiation:", e);
          alert(
            "An error occurred during negotiation. Check console for details.",
          );
        }
      }

      async function startStream() {
        try {
          console.log("Starting stream...");
          pc = await createPeerConnection();
          console.log("Adding video transceiver...");
          pc.addTransceiver("video", { direction: "recvonly" });
          await negotiate();
          console.log("Stream started successfully...");
        } catch (e) {
          console.error("Error starting stream:", e);
          alert(
            "An error occurred while starting the stream. Check console for details.",
          );
        }
      }

      window.addEventListener("load", () => {
        console.log("Window loaded, starting stream...");
        startStream().catch((e) => {
          console.error("Error in startStream:", e);
          alert(
            "An error occurred while starting the stream. Check console for details.",
          );
        });
      });

      playPauseBtn.addEventListener("click", () => {
        if (videoElement.paused) {
          console.log("Playing video...");
          videoElement.play();
          playPauseBtn.textContent = "⏸";
        } else {
          console.log("Pausing video...");
          videoElement.pause();
          playPauseBtn.textContent = "▶";
        }
      });

      videoElement.addEventListener("play", () => {
        console.log("Video play event...");
        playPauseBtn.textContent = "⏸";
      });

      videoElement.addEventListener("pause", () => {
        console.log("Video pause event...");
        playPauseBtn.textContent = "▶";
      });
    </script>
  </body>
</html>
